name: CI

on:
  push:
    branches: [ master, develop, devops ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ master, develop, devops ] # Запуск на pull request в main

#env:
#  COMPOSE_PROJECT_NAME: dev

jobs:
  build-and-test-backend:
    #    runs-on: self-hosted
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # Сборка приложения с использованием docker-compose.dev.yml
      - name: Build app
        run: docker compose -f docker-compose.dev.yml build

      # Запуск backend сервисов с использованием docker-compose.dev.yml
      - name: Start backend services
        run: docker compose -f docker-compose.dev.yml up -d

      # Сборка контейнера для тестов
      - name: Build test container
        run: |
          docker build \
          --file backend/Dockerfile.test \
          --tag test-runner \
          backend

      # Запуск юнит и интеграционных тестов
      - name: Run unit and integration tests
        run: docker run --network=host test-runner pytest tests/unit tests/integration

      #      # Ожидание запуска backend
      #      - name: Wait for backend
      #        run: docker run --network=host test-runner python wait-for-backend.py
      #
      #      # Запуск end-to-end тестов
      #      - name: Run e2e tests
      #        run: docker run --network=host test-runner pytest tests/e2e

      # Выключение сервисов и удаление томов
      - name: Shutdown
        if: always()
        run: docker compose -f docker-compose.dev.yml down -v


  test-frontend:
    #    runs-on: self-hosted
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up pnpm
        run: |
          corepack enable
          corepack prepare pnpm@8.15.5 --activate

      - name: Install dependencies and run frontend tests
        working-directory: frontend
        run: |
          pnpm install
          pnpm test

  build-and-push-to-docker-registry:
    needs: [ build-and-test-backend, test-frontend ]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: self-hosted

    env:
      REGISTRY: registry.skillsnavigator.ru
      TAG: ${{ github.ref_name }}    # имя тега без префикса refs/tags/

    steps:
      - uses: actions/checkout@v3

      - name: Log in to private Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASS }}

      - name: Build all services
        run: docker compose -f docker-compose.build.yml build

      - name: Push all images
        run: docker compose -f docker-compose.build.yml push